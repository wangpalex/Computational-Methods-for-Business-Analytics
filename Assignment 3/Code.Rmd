---
title: "Code"
output: html_document
---

Question 1
Part 1
```{r load_data}
library(readr)
df1 <- hw3q1
df1$age <- as.factor(df1$age)  ## Observe 3 categories: 20-30, 30-40, 40+
df1$received_coupon <- as.factor(df1$received_coupon)
df1$after <- as.factor(df1$after)
summary(df1)
```

Treatment effect:
```{r }
library(dplyr)
diff <- df1 %>% group_by(age, received_coupon, after) %>% summarise(rev_mean = mean(revenue))
diff

# DID 20-30: 
(12.32244 - 11.78103) - (10.36813 - 10.31286)   # 0.48614

# DID 30-40:
(10.32048 - 9.10888) - (8.77142 - 8.45867)   # 0.89885

# DID 40+: 
(12.00626 - 10.71556) - (9.34199 - 9.27426)   # 1.22297

```

Before-vs-after comparisons
```{r before-after}
# for the treatment group
# Age 20-30
12.32244 - 10.36813   # 1.95431
# Age 30-40
10.32048 - 8.77142   # 1.54906
# Age 40+
12.00626 - 9.34199   # 2.66427


# for the non-treatment group
# Age 20-30
11.78103 - 10.31286   # 1.46817
# Age 30-40
9.10888 - 8.45867   # 0.65021
# Age 40+
10.71556 - 9.27426   # 1.4413


# average
# Age 20-30
(1.95431 + 1.46817) / 2   # 1.71124
# Age 30-40
(1.54906 + 0.65021) / 2   # 1.099635
# Age 40+
(2.66427 + 1.4413) / 2   # 2.052785
```


Using felm
```{r}
library(lfe)
library(stargazer)
df1_2030 <- df1 %>% filter(age == "20-30")
df1_3040 <- df1 %>% filter(age == "30-40")
df1_40 <- df1 %>% filter(age == "40+")
lm1 <- felm(revenue ~ after | received_coupon, data = df1_2030)
lm2 <- felm(revenue ~ after | received_coupon, data = df1_3040)
lm3 <- felm(revenue ~ after | received_coupon, data = df1_40)
stargazer(lm1, lm2, lm3, type="text",omit.stat=c("LL","ser","f"),
	model.numbers=TRUE)
```
Thus, it is consistent with the before-vs-after comparisons.



Treated-vs-non-treated comparisons
```{r treated-nontreated}
# before
# Age 20-30
10.36813 - 10.31286	   # 0.05527
# Age 30-40
8.77142 - 8.45867   # 0.31275
# Age 40+
9.34199 - 9.27426   # 0.06773

# after
# Age 20-30
12.32244 - 11.78103	   # 0.54141
# Age 30-40
10.32048 - 9.10888   # 1.2116
# Age 40+
12.00626 - 10.71556   # 1.2907


# average
# Age 20-30
(0.05527 + 0.54141) / 2   # 0.29834
# Age 30-40
(0.31275 + 1.2116) / 2   # 0.762175
# Age 40+
(0.06773 + 1.2907) / 2   # 0.679215
```

Using felm
```{r}
library(lfe)
library(stargazer)

lm4 <- felm(revenue ~ received_coupon | after, data = df1_2030)
lm5 <- felm(revenue ~ received_coupon | after, data = df1_3040)
lm6 <- felm(revenue ~ received_coupon | after, data = df1_40)
stargazer(lm4, lm5, lm6, type="text",omit.stat=c("LL","ser","f"),
	model.numbers=TRUE)
```
Thus, it is consistent with the Treated-vs-non-treated comparison.


Part 2

average treatment effect for age group 20-30 = 0.48614 (revenue gain per user)
average treatment effect for age group 30-40 = 0.89885 (revenue gain per user)
average treatment effect for age group 40+ = 1.22297 (revenue gain per user)

The cost of the promotion is $0.8 per user.
Findings:
1) Profitable to run this promotion among age groups 30-40 and 40+; 40+ is the most profitable age group
profit per user for age group 30-40 = 0.89885 - 0.8 = 0.09885
profit per user for age group 40+ = 1.22297 - 0.8 = 0.42297
2) Unprofitable to run this prommotion among age group 20-30
profit loss per user if running promotion = 0.48614 - 0.8 = -0.31386
3) Overall gain based on the small trial of 12000 by combining 3 age groups:
```{r}
4000 * 0.09885 + 4000 * 0.42297 + 4000 * (-0.31386)   # 831.84
```

Advices:
1) It is favourable to run the promotion among age groups of 30-40 and 40+, and especially promote the coverage of the promotion to age group 40+ and reach out more customers in these two age groups
2) Not favour to run the promotion for age group 20-30; if have to cover this age group, the coverage should be as small as possible
3) Issue the coupons based on customer's age: issue more vouchers for those 30-40 or 40+; less vouchers for those 20-30 e.g. this can be achieved by showing ID to qualify for the voucher or use internal customer age data collected





Question 2
```{r}
df2 <- hw3q2
library(stats4)
```

Part 1
```{r}
likelihood_function1 <- function(beta0, beta1, beta2) {
  Pij = (df2$choices == 0) * 0 + (df2$choices == 1) * (beta1 + df2$p1 * beta0) + (df2$choices == 2) * (beta2 + df2$p2 * beta0) - log(exp(0) + exp(beta1 + df2$p1 * beta0) + exp(beta2 + df2$p2 * beta0))
  return (-sum(Pij))
}

mle1 <- mle(likelihood_function1, start = list(beta0 = 0, beta1 = -0.1, beta2 = -0.1), method = "L-BFGS-B", lower = c(-10, -10, -10), upper = c(10, 10, 10))
summary(mle1)
```
Interpretation of coefficients:
1) beta0 = -0.07906249
Price coefficient. One unit increase in price of a product, either JustGrab or GrabShare, will result in a 0.0791 units decrease in the utility level in average.
2) beta1 = 0.66638432
The preference for JustGrab (j = 1) relative to not choosing any services is higher i.e. JustGrab is a more attractive option / generates higher utility than not choosing any (outside option).
3) beta2 = -1.66094764
The preference for JustGrab (j = 2) relative to not choosing any services is lower i.e. JustGrab is a less attractive option / generates lower utility than not choosing any (outside option).


Part 2
Endogeneity issue:
Demand for GrabShare is an omitted variable resulting in the endogeneity issue. During the morning peak hours when many people rush for school and work, the demand for GrabShare is high. Higher demand will lead to higher surge price. Also, higher demand implies higher utility gained by customer once they obtain the GrabShare service. Therefore, omitting the demand variable in the model will lead to omitted vairable bias, resulting in endogeneity.

Solution:
Demand for GrabShare is reflected by surge2, which is demand-driven. Because the underlying demand is unobserved to us, we can include surge2 in the model instead.

Use IV. Surge pricing only affects customer's preference or utility level only through the final price. Therefore, surge price is a good intrumental variable when running regression of utility on price.
Need to consider surge_1?
```{r}
df2$price <- (df2$choices==1) * df2$p1 + (df2$choices==2) * df2$p2
#df2$product <- as.factor(as.character(df2$choices))
library(AER)
lm7 <- ivreg(choices ~ price | surge_2, data = df2)
summary(lm7)
```

naivereg? LIVE?
```{r}
library(naivereg)
LIVE(df2$choices, df2$price, df2$surge_2, penalty = c("SCAD", "MCP", "lasso"), nfolds = 5,
endogenous.index = c(), gamma = 3.7, alpha = 1, lambda.min = 0.05, nlambda = 100)

```




Part 3
```{r}
beta0 <- -0.07906144
beta1 <- 0.66638457
beta2 <- 1.66094662
```


If only product 1 JustGrab is in the market, the optimal price is 18.39883.
```{r JustGrab only}
profit_function1 = function(price1) {
  Profit1 = price1 * (exp(beta1 + price1 * beta0) / (1 + exp(beta1 + price1 * beta0)))

	return(-Profit1)
}

optim(c(1), profit_function1, method = "BFGS")
```

If only product 2 GrabShare is in the market, the optimal price is 23.24592.
```{r GrabShare only}
profit_function2 = function(price2) {
  Profit2 = price2 * (exp(beta2 + price2 * beta0) / (1 + exp(beta2 + price2 * beta0)))

	return(-Profit2)
}

optim(c(1), profit_function2, method = "BFGS")
```


If product 1&2 are both in the market, the optimal price is 25.12169 for JustGrab and 25.14357 for GrabShare.
```{r}
profit_function3=function(prices){
  price1 = prices[1]
	price2 = prices[2]

	Profit1 = price1 * (exp(beta1 + price1 * beta0) / (1 + exp(beta1 + price1 * beta0) + exp(beta2 + price2 * beta0)))

	Profit2 = price2 * (exp(beta2 + price2 * beta0) / (1 + exp(beta1 + price1 * beta0) + exp(beta2 + price2 * beta0)))

	return(-(Profit1+Profit2))
}

optim(c(1, 1), profit_function3, method = "BFGS")
```

Reason:
When both products are in the market, they are substitutes. When two substitutes are owned by the same firm, the firm shall take the cannibalization effect into account. When the firm cuts price for one product, it loses sales from the other product. This gives firm incentive to price relatively high in multiproduct case. Higher prices for both products than the case where only one product exists in the market.





Question 3

Part 1
Cost how???? How do I know how many products to produce each firm?
Before Merger
```{r}
# parameters
beta0 = -0.03
beta1 = 2
beta2 = 1
beta3 = 2

# objective function of firm 1
profit_function1=function(price1){
	Profit1=price1*(exp(beta1+price1*beta0)/(1+exp(beta1+price1*beta0)+exp(beta2+price2*beta0) + exp(beta3 + price3 * beta0))) - 
	return(-Profit1)
}

# objective function  of firm 2
profit_function2=function(price2){
	Profit2=price2*(exp(beta2+price2*beta0)/(1+exp(beta1+price1*beta0)+exp(beta2+price2*beta0)+ exp(beta3 + price3 * beta0)))
	return(-Profit2)
}

# objective function  of firm 3
profit_function3=function(price3){
	Profit3=price3*(exp(beta3+price3*beta0)/(1+exp(beta1+price1*beta0)+exp(beta2+price2*beta0)+ exp(beta3 + price3 * beta0)))
	return(-Profit3)
}
```

Find pre-merger equilibrium
```{r}
prices=c(0,0,0)
i=0
error=1
Iter=100
Tol=1e-10
while (i<Iter&error>Tol){
	i=i+1
	price1=prices[1]
	price2=prices[2]
	price3=prices[3]
	prices[1]=optim(c(1), profit_function1, method = "BFGS")$par
	prices[2]=optim(c(1), profit_function2, method = "BFGS")$par
	prices[3]=optim(c(1), profit_function3, method = "BFGS")$par

	error=abs(prices[1]-price1)+abs(prices[2]-price2) + abs(prices[3]-price3)
}
prices
```

Firm 1's price: 49.30882
Firm 2's price: 39.58759
Firm 3's price: 49.30882






After Merger
```{r}
# parameters
beta0 = -0.03
beta1 = 2
beta2 = 1
beta3 = 2
price3 = 49.30882 # fixed

# objective function of firm 1 & 2 (multiproduct)
profit_function12=function(prices12){
  price1 = prices12[1]
	price2 = prices12[2]
	
	Profit1 = price1 * (exp(beta1 + price1 * beta0) / (1 + exp(beta1 + price1 * beta0) + exp(beta2 + price2 * beta0) + exp(beta3 + price3 * beta0)))

	Profit2 = price2 * (exp(beta2 + price2 * beta0) / (1 + exp(beta1 + price1 * beta0) + exp(beta2 + price2 * beta0) + exp(beta3 + price3 * beta0)))
	
	return(-(Profit1+Profit2))
}
```


Find post-merger equilibrium of firm 1 and 2 (firm 3's price remains constant)
```{r}
optim(c(1, 1), profit_function12, method = "BFGS")
```
Firm 1's price: 56.42097 
Firm 2's price: 56.36317
Firm 3's price: 49.30882 (stay constant)




Part 2 (1)
```{r}
# objective function of firm 1 & 2 (multiproduct)
profit_function12=function(prices12){
  price1 = prices12[1]
	price2 = prices12[2]
	
	Profit1 = price1 * (exp(beta1 + price1 * beta0) / (1 + exp(beta1 + price1 * beta0) + exp(beta2 + price2 * beta0) + exp(beta3 + price3 * beta0)))

	Profit2 = price2 * (exp(beta2 + price2 * beta0) / (1 + exp(beta1 + price1 * beta0) + exp(beta2 + price2 * beta0) + exp(beta3 + price3 * beta0)))
	
	return(-(Profit1+Profit2))
}

# objective function  of firm 3 (same)
profit_function3=function(price3){
	Profit3=price3*(exp(beta3+price3*beta0)/(1+exp(beta1+price1*beta0)+exp(beta2+price2*beta0)+ exp(beta3 + price3 * beta0)))
	return(-Profit3)
}
```

```{r}
prices=c(0,0,0)
i=0
error=1
Iter=100
Tol=1e-10
while (i<Iter&error>Tol){
	i=i+1
	prices12 = c(prices[1], prices[2])
	price3=prices[3]
	temp=optim(c(1, 1), profit_function12, method = "BFGS")$par
	prices[1] = temp[1]
	prices[2] = temp[2]
	prices[3]=optim(c(1), profit_function3, method = "BFGS")$par

	error=abs(prices[1]-price1)+abs(prices[2]-price2) + abs(prices[3]-price3)
}
prices
```
Firm 1's price: 53.99123
Firm 2's price: 53.99086
Firm 3's price: 39.95663



Cost????